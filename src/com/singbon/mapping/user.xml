<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.singbon.dao.UserDAO">
	<resultMap id="user" type="com.singbon.entity.User">
	</resultMap>
	<parameterMap type="com.singbon.entity.User" id="user2" />
	<insert id="insert" parameterMap="user2" useGeneratedKeys="true" keyProperty="userId">
		insert into user
		(companyId,deptId,username,shortName,userNO,sex,cardID,cardNO,cardSN,cardSeq,cardTypeId,cardFunc,cardIdentity,status,beginDate,invalidDate,cardMakeDate,consumePwd,identityPwd,totalFare,oddFare,opCount)
		values
		(#{companyId},#{deptId},#{username},#{shortName},#{userNO},#{sex},#{cardID},#{cardNO},#{cardSN},#{cardSeq},#{cardTypeId},#{cardFunc},#{cardIdentity},#{status},#{beginDate},#{invalidDate},#{cardMakeDate},#{consumePwd},#{identityPwd},#{totalFare},#{oddFare},#{opCount})
	</insert>
	<update id="update" parameterMap="user2">
		update user set
		username=#{username},shortName=#{shortName},userNO=#{userNO},sex=#{sex},cardID=#{cardID},cardTypeId=#{cardTypeId},cardFunc=#{cardFunc},cardIdentity=#{cardIdentity},endDate=#{endDate},consumePwd=#{consumePwd},identityPwd=#{identityPwd}
		where userId=#{userId}
	</update>
	<update id="infoCard" parameterMap="user2">
		update user set cardNO=#{cardNO},cardSN=#{cardSN},cardSeq=1,status=241,cardMakeDate=now(),totalFare=#{totalFare},oddFare=#{oddFare},opCount=#{opCount}
		where userId=#{userId}
	</update>
	<update id="remakeCard" parameterMap="user2">
		update user set cardNO=#{cardNO},cardSN=#{cardSN},cardSeq=#{cardSeq},status=241
		where userId=#{userId}
	</update>
	<update id="unloss" parameterMap="user2">
		update user set cardNO=#{cardNO},status=241
		where userId=#{userId}
	</update>
	<update id="changeStatus">
		update user set status=#{status}
		where userId=#{userId}
	</update>
	<update id="changeNewCard">
		update user set cardNO=#{cardNO},cardSN=#{cardSN},cardSeq=cardSeq+1
		where userId=#{userId}
	</update>
	<update id="updateByCard" parameterMap="user2">
		update user set invalidDate=#{invalidDate},status=#{status},cardSeq=#{cardSeq},cardTypeId=#{cardTypeId},totalFare=#{totalFare},
		oddFare=#{oddFare},opCount=#{opCount},subsidyOddFare=#{subsidyOddFare},subsidyOpCount=#{subsidyOpCount},subsidyVersion=#{subsidyVersion}
		where userId=#{userId}
	</update>
	<update id="changeToNewDept">
		update user set deptId=#{toDeptId} where userId in (		
		<foreach collection="userIds" item="item" index="index" separator=",">  
    		(#{item})
		</foreach>
		)
	</update>
	<update id="changeFromDeptToNew">
		update user set deptId=#{toDeptId} where deptId=#{fromDeptId}
	</update>
	<update id="changeFare">
		update user set totalFare=totalFare+#{opFare},oddFare=oddFare+#{opFare} where userId=#{userId}
	</update>
	<delete id="delete" parameterType="int">
		delete from user where status=0 and userId in (		
		<foreach collection="userIds" item="item" index="index" separator=",">  
    		(#{item})
		</foreach>
		)
	</delete>
	<select id="selectById" resultMap="user">
		select * from user where userId=#{id}
	</select>
	<select id="selectByUserIdCardSN" resultMap="user">
		select * from user where companyId=#{companyId} and cardSN=#{cardSN}
<!-- 		select * from user where companyId=#{companyId} and userId=#{userId} and cardSN=#{cardSN} -->
	</select>
	<select id="selectNoCardByDeptId" resultMap="user">
		select * from user where status=0 and deptId=#{deptId}
	</select>
	<select id="selectMaxCardNO" resultType="java.lang.Integer">
		select ifnull(max(cardNO),0)+1 cardNO from user where companyId=#{companyId}
	</select>
	<select id="selectCountByCardSN" resultType="java.lang.Integer">
		select count(userId) from user where companyId=#{companyId} and cardSN=#{cardSN}
	</select>
	<select id="selectCountByUserNO" resultType="java.lang.Integer">
		select count(userId) from user where companyId=#{companyId} and userNO=#{userNO}
	</select>
	<select id="selectCountByUserNOUserId" resultType="java.lang.Integer">
		select count(userId) from user where companyId=#{companyId} and userNO=#{userNO} and userId!=#{userId}
	</select>
	<select id="selectByCondition" resultMap="user">
		select * from user
		<where>
			<if test="deptId!=null and deptId > 0">
				and deptId=#{deptId}
			</if>
			<if test="searchStr!=null">
				and (
				username like concat('%',#{searchStr},'%')
				or shortName like concat('%',#{searchStr},'%')
				or userNO like concat('%',#{searchStr},'%')
				)
			</if>
		</where>
	</select>
	<sql id="whereSelectByPage">
		where companyId=#{companyId}
		<if test="nameStr!=null and nameStr!=''">
		 and (userNO like '%${nameStr}%' or username like '%${nameStr}%' or shortName like '%${nameStr}%')
		</if>
		<if test="deptId!=null and deptId!=-1">
		 and deptId=#{deptId}
		</if>
		<if test="cardTypeId!=null and cardTypeId!=-1">
		 and cardTypeId=#{cardTypeId}
		</if>
		<if test="sex!=null and sex!=-1">
		 and sex=#{sex}
		</if>
		<if test="status!=null">
			<if test="status!=-1 and status!=-2">
		 		and status=#{status}
		 	</if>
			<if test="status==-2">
		 		and status not in(0,241,243,244)
		 	</if>
		</if>
		<if test="dateType!=null and dateType!=-1">
			<if test="dateType==0">
				<if test="beginDate!=null and beginDate!=''">
					and cardMakeDate&gt;=#{beginDate}
				</if>
				<if test="endDate!=null and endDate!=''">
					and cardMakeDate&lt;=#{endDate}
				</if>
			</if>
			<if test="dateType==1">
				<if test="beginDate!=null and beginDate!=''">
					and invalidDate&gt;=#{beginDate}
				</if>
				<if test="endDate!=null and endDate!=''">
					and invalidDate&lt;=#{endDate}
				</if>
			</if>
		</if>
	</sql>
	<select id="selectByPage" resultMap="user">
		select count(userId) userId,null userNO,null username, null cardNO,null sex,null cardID,null cardTypeId,null status from user <include refid="whereSelectByPage"/> union 
		(select userId,userNO,username,cardNO,sex,cardID,cardTypeId,status from user <include refid="whereSelectByPage"/> limit #{offset},#{numPerPage});
	</select>
</mapper>
